provider "aws" {
  region = "ap-southeast-2"
}

resource "aws_instance" "c2" {
  ami             = "${C2_AMI}"
  instance_type   = "t2.micro"
  key_name        = "${C2_KEYPAIR_NAME}_${C2_NONCE}"
  security_groups = [
    "allow_all_${C2_NONCE}"
  ]
  depends_on      = [
    "aws_key_pair.c2_keypair",
    "aws_security_group.allow_all"
  ]
}

resource "aws_key_pair" "c2_keypair" {
  key_name   = "${C2_KEYPAIR_NAME}_${C2_NONCE}"
  public_key = <<KEY
${C2_KEYPAIR_PUB}
KEY
}

resource "aws_security_group" "allow_all" {
  name        = "allow_all_${C2_NONCE}"
  description = "allow all inbound traffic"

  ingress {
    from_port   = 0
    to_port     = 0
    protocol    = -1
    cidr_blocks = [
      "0.0.0.0/0"
    ]
  }
}

output "c2_ip" {
    value = "${aws_instance.c2.public_ip}"
}
